<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Cetak Label (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.hidden { visibility: hidden; opacity: 0; }
        .pagination-btn { display: inline-flex; align-items: center; justify-content: center; width: 2.5rem; height: 2.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s, color 0.2s; }
        .pagination-btn.active { background-color: #4f46e5; color: white; }
        .pagination-btn:not(.active):not(.disabled) { background-color: #334155; }
        .pagination-btn:not(.active):not(.disabled):hover { background-color: #475569; }
        .pagination-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        .search-results { max-height: 200px; overflow-y: auto; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        .modal-header { cursor: move; }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-sans">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- BAGIAN 1: ANTRIAN CETAK -->
        <section id="print-queue-section">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-white">Antrian Cetak</h1>
                    <p class="text-slate-400 mt-1">Siapkan dan kelola daftar kiriman yang akan dicetak.</p>
                </div>
                <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <button id="add-kiriman-btn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        + Buat Kiriman
                    </button>
                    <button id="print-batch-btn" class="flex items-center bg-lime-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        Cetak Antrian
                    </button>
                </div>
            </header>
            <div class="bg-slate-800 rounded-xl shadow-lg overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                        <tr>
                            <th class="px-6 py-3">Tujuan</th>
                            <th class="px-6 py-3">Total Label</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="print-queue-table-body">
                        <tr><td colspan="4" class="text-center p-8">Antrian cetak masih kosong.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <hr class="my-12 border-slate-700">

        <!-- BAGIAN 2: LOG CETAK -->
        <section id="log-section">
            <header class="mb-6">
                <h1 class="text-2xl font-bold text-white">Log Cetak</h1>
                <p class="text-slate-400 mt-1">Riwayat semua label yang telah diproses.</p>
            </header>
            <div class="bg-slate-800 rounded-xl shadow-lg overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                        <tr>
                            <th class="px-6 py-3">ID Log</th>
                            <th class="px-6 py-3">Tujuan</th>
                            <th class="px-6 py-3">Detail Cetak</th>
                            <th class="px-6 py-3">Waktu Cetak</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body"></tbody>
                </table>
            </div>
            <div class="flex items-center justify-end mt-6">
                <nav id="log-pagination-controls" class="flex items-center space-x-2"></nav>
            </div>
        </section>

        <hr class="my-12 border-slate-700">

        <!-- BAGIAN 3: MANAJEMEN ALAMAT -->
        <section id="address-management-section">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-white">Manajemen Alamat</h1>
                    <p class="text-slate-400 mt-1">Kelola semua data tujuan di database.</p>
                </div>
                <button id="add-new-btn" class="mt-4 sm:mt-0 flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    + Tambah Alamat Baru
                </button>
            </header>
            <div class="mb-4">
                <input type="text" id="search-input" placeholder="Cari alamat..." class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg">
            </div>
            <div class="bg-slate-800 rounded-xl shadow-lg overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                        <tr>
                            <th class="px-6 py-3">ID</th>
                            <th class="px-6 py-3">PT Tujuan</th>
                            <th class="px-6 py-3">Instansi</th>
                            <th class="px-6 py-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="destination-table-body"></tbody>
                </table>
            </div>
            <div class="flex items-center justify-between mt-6">
                <div id="pagination-info" class="text-sm text-slate-400"></div>
                <nav id="pagination-controls" class="flex items-center space-x-2"></nav>
            </div>
        </section>
    </div>

    <!-- Semua Modal -->
    <div id="address-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl modal-content">
            <div class="modal-header flex justify-between items-center p-6 border-b border-slate-700">
                <h2 id="address-modal-title" class="text-2xl font-bold text-white"></h2>
                <button class="cancel-modal-btn text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="address-form" class="p-6 space-y-4"></form>
        </div>
    </div>

    <!-- MODAL KIRIMAN (ENHANCED) -->
    <div id="kiriman-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-4xl modal-content">
            <div class="modal-header flex justify-between items-center p-6 border-b border-slate-700">
                <h2 id="kiriman-modal-title" class="text-2xl font-bold text-white">Buat Kiriman Baru</h2>
                <button class="cancel-modal-btn text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <!-- STEP 1: PILIH ALAMAT -->
                <div id="step-1-kiriman">
                    <label for="kiriman-search" class="block mb-2 text-sm font-medium">1. Cari & Pilih Alamat Tujuan</label>
                    <input type="text" id="kiriman-search" placeholder="Ketik untuk mencari..." class="bg-slate-700 w-full p-2.5 rounded-lg">
                    <div id="search-results" class="bg-slate-700 border border-slate-600 rounded-lg mt-1 hidden search-results"></div>
                </div>

                <!-- STEP 2: ATUR GRUP LABEL -->
                <div id="step-2-kiriman" class="hidden">
                    <div class="bg-slate-700/50 p-4 rounded-lg mb-4">
                        <p class="text-white font-semibold" id="selected-destination-text"></p>
                        <p class="text-sm text-slate-400" id="selected-destination-address"></p>
                    </div>
                    
                    <!-- Form untuk Menambah Grup Baru -->
                    <div id="group-form-container" class="border-2 border-dashed border-slate-600 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-3 text-white">Tambah Grup Label Baru</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs">Dari Box No.</label>
                                <input type="number" id="group-from" min="1" placeholder="Mulai" class="bg-slate-700 mt-1 w-full p-2.5 rounded-lg">
                            </div>
                            <div>
                                <label class="text-xs">Sampai Box No.</label>
                                <input type="number" id="group-to" min="1" placeholder="Akhir" class="bg-slate-700 mt-1 w-full p-2.5 rounded-lg">
                            </div>
                            <input type="text" id="group-petugas" placeholder="Petugas (berlaku untuk grup ini)" class="bg-slate-700 w-full p-2.5 rounded-lg">
                            <input type="text" id="group-berat" placeholder="Berat (berlaku untuk grup ini)" class="bg-slate-700 w-full p-2.5 rounded-lg">
                        </div>
                        <hr class="my-4 border-slate-600">
                        <div id="multi-product-container" class="space-y-3">
                            <!-- Product rows will be injected here by JS -->
                        </div>
                        <button type="button" id="add-product-row-btn" class="mt-3 text-sm bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded-md">+ Tambah Produk</button>
                        <div class="text-right mt-4">
                            <button type="button" id="add-group-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Tambah Grup</button>
                        </div>
                    </div>

                    <!-- Ringkasan Grup yang Ditambahkan -->
                    <div class="mt-6">
                        <h3 class="font-bold text-lg mb-2 text-white">Ringkasan Grup</h3>
                        <div id="groups-summary-container" class="space-y-2">
                           <p class="text-slate-400 text-sm">Belum ada grup yang ditambahkan.</p>
                        </div>
                    </div>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="flex justify-end space-x-4 pt-6">
                    <button type="button" class="cancel-modal-btn px-5 py-2 bg-slate-600 rounded-md">Batal</button>
                    <button type="button" id="add-to-queue-btn" class="px-5 py-2 bg-blue-600 rounded-md">Simpan Kiriman ke Antrian</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="print-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-md modal-content">
             <div class="modal-header flex justify-between items-center p-6 border-b border-slate-700">
                <h2 class="text-2xl font-bold text-white">Konfirmasi Cetak</h2>
                <button class="cancel-modal-btn text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div id="print-summary" class="mb-4 text-slate-300"></div>
                <form id="print-final-form">
                    <input type="text" id="printer_ip" name="printer_ip" placeholder="Masukkan IP Printer Zebra" class="bg-slate-700 w-full p-2.5 rounded-lg mb-4" required>
                    <div class="flex items-center mb-4">
                        <input id="debug-mode" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600" checked>
                        <label for="debug-mode" class="ml-2 text-sm font-medium text-gray-300">Mode Debug (Simpan ke file .txt)</label>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" class="cancel-modal-btn px-5 py-2 bg-slate-600 rounded-md">Batal</button>
                        <button type="submit" class="px-5 py-2 bg-green-600 rounded-md">Cetak Sekarang</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="w-full h-24 flex items-center justify-center bg-gray-900 text-white">
    <div class="text-center text-sm">
        &copy; 2025 kaayeey-sides. All rights reserved.
         for my contact : +62-812-2113-5988
    </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'http://localhost:5000/api';
        
        // --- STATE ---
        let printQueue = []; // { id, pt_tujuan, status, groups: [{from, to, petugas, berat, produk_list: [{nama, qty}] }] }
        let allDestinationsForSearch = [];
        let addressCurrentPage = 1;
        let addressCurrentSearch = '';
        let addressDebounceTimer;
        let currentAddressItems = [];
        let logCurrentPage = 1;

        // --- State untuk Modal Kiriman ---
        let selectedKiriman = null;
        let tempGroups = [];
        let editingQueueIndex = null;

        // --- ELEMEN UI ---
        const printQueueTableBody = document.getElementById('print-queue-table-body');
        const addKirimanBtn = document.getElementById('add-kiriman-btn');
        const printBatchBtn = document.getElementById('print-batch-btn');
        const logTableBody = document.getElementById('log-table-body');
        const logPaginationControls = document.getElementById('log-pagination-controls');
        const addressTableBody = document.getElementById('destination-table-body');
        const addressSearchInput = document.getElementById('search-input');
        const addressPaginationControls = document.getElementById('pagination-controls');
        const addressPaginationInfo = document.getElementById('pagination-info');
        const addNewAddressBtn = document.getElementById('add-new-btn');
        
        // Elemen Modal
        const addressModal = document.getElementById('address-modal');
        const addressModalTitle = document.getElementById('address-modal-title');
        const addressForm = document.getElementById('address-form');
        const kirimanModal = document.getElementById('kiriman-modal');
        const kirimanModalTitle = document.getElementById('kiriman-modal-title');
        const printConfirmModal = document.getElementById('print-confirm-modal');
        const printSummary = document.getElementById('print-summary');
        const printFinalForm = document.getElementById('print-final-form');
        
        // Elemen Modal Kiriman (Enhanced)
        const step1Kiriman = document.getElementById('step-1-kiriman');
        const step2Kiriman = document.getElementById('step-2-kiriman');
        const kirimanSearchInput = document.getElementById('kiriman-search');
        const searchResultsDiv = document.getElementById('search-results');
        const selectedDestinationText = document.getElementById('selected-destination-text');
        const selectedDestinationAddress = document.getElementById('selected-destination-address');
        const multiProductContainer = document.getElementById('multi-product-container');
        const addProductRowBtn = document.getElementById('add-product-row-btn');
        const addGroupBtn = document.getElementById('add-group-btn');
        const groupsSummaryContainer = document.getElementById('groups-summary-container');
        const addToQueueBtn = document.getElementById('add-to-queue-btn');

        // --- FUNGSI-FUNGSI ---

        const fetchAllDestinationsForSearch = async () => {
            try {
                const response = await fetch(`${API_URL}/destinations?all=true`);
                if (!response.ok) throw new Error('Gagal mengambil daftar alamat');
                const data = await response.json();
                allDestinationsForSearch = data.items;
            } catch (error) { 
                console.error("Gagal mengambil daftar alamat:", error);
                alert("Gagal terhubung ke server. Pastikan server Flask (app.py) sudah berjalan.");
            }
        };

        // --- FUNGSI BAGIAN ANTRIAN CETAK (ENHANCED) ---
        const renderPrintQueue = () => {
            printQueueTableBody.innerHTML = '';
            if (printQueue.length === 0) {
                printQueueTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8">Antrian cetak masih kosong.</td></tr>`;
                return;
            }
            printQueue.forEach((item, index) => {
                const totalLabels = item.groups.reduce((acc, group) => acc + (group.to - group.from + 1), 0);
                const statusClass = item.status === 'done' ? 'text-green-400' : 'text-yellow-400';
                const row = `
                    <tr class="bg-slate-800 border-b border-slate-700">
                        <td class="px-6 py-4">${item.pt_tujuan}</td>
                        <td class="px-6 py-4">${totalLabels} Label (${item.groups.length} Grup)</td>
                        <td class="px-6 py-4 font-semibold ${statusClass}">${item.status === 'done' ? 'Sudah Cetak' : 'Belum Cetak'}</td>
                        <td class="px-6 py-4 text-center space-x-3">
                            <button class="edit-queue-btn font-medium text-indigo-400 hover:underline" data-index="${index}">Edit</button>
                            <button class="delete-queue-btn font-medium text-red-500 hover:underline" data-index="${index}">Hapus</button>
                        </td>
                    </tr>
                `;
                printQueueTableBody.insertAdjacentHTML('beforeend', row);
            });
        };

        const addProductRow = (product = {nama: '', qty: ''}) => {
            const productRow = document.createElement('div');
            productRow.className = 'flex items-center space-x-2 product-row';
            productRow.innerHTML = `
                <input type="text" name="group-produk-nama" placeholder="Nama Produk" class="bg-slate-600 flex-grow p-2 rounded-lg" value="${product.nama}">
                <input type="text" name="group-produk-qty" placeholder="Qty" class="bg-slate-600 w-24 p-2 rounded-lg" value="${product.qty}">
                <button type="button" class="remove-product-row-btn text-red-500 font-bold text-xl">&times;</button>
            `;
            multiProductContainer.appendChild(productRow);
        };
        
        const resetGroupForm = () => {
            document.getElementById('group-from').value = '';
            document.getElementById('group-to').value = '';
            document.getElementById('group-petugas').value = '';
            document.getElementById('group-berat').value = '';
            multiProductContainer.innerHTML = '';
            addProductRow();
        };

        const renderGroupsSummary = () => {
            groupsSummaryContainer.innerHTML = '';
            if(tempGroups.length === 0) {
                groupsSummaryContainer.innerHTML = `<p class="text-slate-400 text-sm">Belum ada grup yang ditambahkan.</p>`;
                return;
            }
            tempGroups.forEach((group, index) => {
                const produkPreview = group.produk_list.map(p => p.nama).join(', ') || 'Tidak ada produk';
                const card = `
                    <div class="bg-slate-700 p-3 rounded-lg">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-white">Grup ${index + 1}: Box ${group.from} - ${group.to}</p>
                            <button class="delete-group-btn text-red-500 text-xl font-bold" data-index="${index}">&times;</button>
                        </div>
                        <p class="text-sm text-slate-300">${produkPreview}</p>
                    </div>
                `;
                groupsSummaryContainer.insertAdjacentHTML('beforeend', card);
            });
        };
        
        const openKirimanModal = (item = null, index = null) => {
            editingQueueIndex = index;
            kirimanModal.classList.remove('hidden');
            
            kirimanSearchInput.value = '';
            kirimanSearchInput.disabled = false;
            step1Kiriman.classList.remove('hidden');
            step2Kiriman.classList.add('hidden');
            selectedKiriman = null;
            tempGroups = [];
            renderGroupsSummary();
            resetGroupForm();
            
            if (item) {
                kirimanModalTitle.textContent = 'Edit Kiriman';
                selectedKiriman = { id: item.id, pt_tujuan: item.pt_tujuan };
                tempGroups = JSON.parse(JSON.stringify(item.groups));

                kirimanSearchInput.value = item.pt_tujuan;
                kirimanSearchInput.disabled = true;
                
                selectedDestinationText.textContent = item.pt_tujuan;
                selectedDestinationAddress.textContent = allDestinationsForSearch.find(d=>d.id == item.id)?.alamat || 'Alamat tidak ditemukan';
                
                step2Kiriman.classList.remove('hidden');
                
                renderGroupsSummary();
                const nextBoxNumber = (tempGroups.reduce((max, g) => Math.max(max, g.to), 0) || 0) + 1;
                document.getElementById('group-from').value = nextBoxNumber;
            } else {
                kirimanModalTitle.textContent = 'Buat Kiriman Baru';
                kirimanSearchInput.focus();
            }
        };

        // --- FUNGSI BAGIAN LOG & ALAMAT ---
        const fetchLogs = async (page = 1) => {
            logCurrentPage = page;
            logTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8">Memuat log...</td></tr>`;
            try {
                const response = await fetch(`${API_URL}/logs?page=${page}`);
                if (!response.ok) throw new Error('Gagal mengambil data log');
                const data = await response.json();
                renderLogTable(data.items);
                renderLogPagination(data);
            } catch (error) {
                logTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-500">${error.message}</td></tr>`;
            }
        };

        const renderLogTable = (logs) => {
            logTableBody.innerHTML = '';
            if (logs.length === 0) {
                logTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8">Belum ada riwayat cetak.</td></tr>`;
                return;
            }
            logs.forEach(log => {
                const row = `
                    <tr class="bg-slate-800 border-b border-slate-700">
                        <td class="px-6 py-4">${log.id}</td>
                        <td class="px-6 py-4">${log.pt_tujuan}</td>
                        <td class="px-6 py-4">Box ${log.box_number} - ${log.produk || 'N/A'}</td>
                        <td class="px-6 py-4">${new Date(log.tanggal_print).toLocaleString('id-ID')}</td>
                    </tr>
                `;
                logTableBody.insertAdjacentHTML('beforeend', row);
            });
        };

        const renderLogPagination = (data) => {
            const { total_pages, current_page } = data;
            logPaginationControls.innerHTML = '';
            if (total_pages <= 1) return;
            const createButton = (page, text, isDisabled = false) => `<button class="pagination-btn ${page === current_page ? 'active' : ''} ${isDisabled ? 'disabled' : ''}" data-page="${page}" ${isDisabled ? 'disabled' : ''}>${text}</button>`;
            logPaginationControls.insertAdjacentHTML('beforeend', createButton(current_page - 1, '&laquo;', current_page === 1));
            for (let i = 1; i <= total_pages; i++) {
                logPaginationControls.insertAdjacentHTML('beforeend', createButton(i, i));
            }
            logPaginationControls.insertAdjacentHTML('beforeend', createButton(current_page + 1, '&raquo;', current_page === total_pages));
        };

        const fetchAddressData = async (page = 1, search = '') => {
            addressCurrentPage = page;
            addressCurrentSearch = search;
            addressTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 font-semibold">Memuat data...</td></tr>`;
            try {
                const response = await fetch(`${API_URL}/destinations?page=${page}&search=${search}`);
                if (!response.ok) throw new Error('Gagal mengambil data alamat');
                const data = await response.json();
                currentAddressItems = data.items;
                renderAddressTable(data.items);
                renderAddressPagination(data);
            } catch (error) {
                addressTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-500">${error.message}</td></tr>`;
            }
        };

        const renderAddressTable = (items) => {
            addressTableBody.innerHTML = '';
            if (items.length === 0) {
                addressTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8">Data alamat tidak ditemukan.</td></tr>`;
                return;
            }
            items.forEach(dest => {
                const row = `
                    <tr class="bg-slate-800 border-b border-slate-700 hover:bg-slate-700/50">
                        <td class="px-6 py-4 font-medium text-white">${dest.id}</td>
                        <td class="px-6 py-4">${dest.pt_tujuan}</td>
                        <td class="px-6 py-4">${dest.instansi}</td>
                        <td class="px-6 py-4 text-center">
                            <button class="edit-address-btn font-medium text-indigo-400 hover:underline mr-3" data-id="${dest.id}">Edit</button>
                        </td>
                    </tr>
                `;
                addressTableBody.insertAdjacentHTML('beforeend', row);
            });
        };

        const renderAddressPagination = (data) => {
            const { total_pages, current_page } = data;
            addressPaginationControls.innerHTML = '';
            addressPaginationInfo.innerHTML = `Halaman ${current_page} dari ${total_pages}`;
            if (total_pages <= 1) return;
            const createButton = (page, text, isDisabled = false) => `<button class="pagination-btn ${page === current_page ? 'active' : ''} ${isDisabled ? 'disabled' : ''}" data-page="${page}" ${isDisabled ? 'disabled' : ''}>${text}</button>`;
            const createEllipsis = () => `<span class="pagination-btn disabled">...</span>`;
            addressPaginationControls.insertAdjacentHTML('beforeend', createButton(current_page - 1, '&laquo;', current_page === 1));
            let pages = [];
            if (total_pages <= 7) {
                for (let i = 1; i <= total_pages; i++) pages.push(i);
            } else {
                pages.push(1);
                if (current_page > 3) pages.push('...');
                for (let i = Math.max(2, current_page - 1); i <= Math.min(total_pages - 1, current_page + 1); i++) pages.push(i);
                if (current_page < total_pages - 2) pages.push('...');
                pages.push(total_pages);
            }
            pages.forEach(page => {
                addressPaginationControls.insertAdjacentHTML('beforeend', page === '...' ? createEllipsis() : createButton(page, page));
            });
            addressPaginationControls.insertAdjacentHTML('beforeend', createButton(current_page + 1, '&raquo;', current_page === total_pages));
        };

        const openAddressModal = (title, data = null) => {
            addressModalTitle.textContent = title;
            addressForm.innerHTML = `
                <input type="hidden" name="id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input name="pt" placeholder="Nama PT" class="bg-slate-700 w-full p-2.5 rounded-lg" required>
                    <input name="instansi" placeholder="Nama Instansi" class="bg-slate-700 w-full p-2.5 rounded-lg" required>
                </div>
                <input name="tujuan" placeholder="Tujuan (cth: DINKES ACEH)" class="bg-slate-700 w-full p-2.5 rounded-lg" required>
                <textarea name="alamat" rows="3" placeholder="Alamat Lengkap" class="bg-slate-700 w-full p-2.5 rounded-lg" required></textarea>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input name="provinsi" placeholder="Provinsi" class="bg-slate-700 w-full p-2.5 rounded-lg" required>
                    <input name="kontak" placeholder="Kontak (Opsional)" class="bg-slate-700 w-full p-2.5 rounded-lg">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" class="cancel-modal-btn px-5 py-2 bg-slate-600 rounded-md">Batal</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 rounded-md">Simpan</button>
                </div>
            `;
            if (data) {
                Object.keys(data).forEach(key => {
                    const input = addressForm.elements[key];
                    if (input) input.value = data[key];
                });
            }
            addressModal.classList.remove('hidden');
        };

        // --- EVENT LISTENERS ---
        
        addKirimanBtn.addEventListener('click', () => openKirimanModal());

        kirimanSearchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if (!term) { searchResultsDiv.classList.add('hidden'); return; }
            const filtered = allDestinationsForSearch.filter(d => d.pt_tujuan?.toLowerCase().includes(term) || d.instansi?.toLowerCase().includes(term)).slice(0, 5);
            searchResultsDiv.innerHTML = '';
            if (filtered.length > 0) {
                searchResultsDiv.classList.remove('hidden');
                filtered.forEach(dest => {
                    searchResultsDiv.innerHTML += `<div class="p-2 hover:bg-slate-600 cursor-pointer" data-id="${dest.id}">${dest.pt_tujuan}</div>`;
                });
            } else { searchResultsDiv.classList.add('hidden'); }
        });

        searchResultsDiv.addEventListener('click', (e) => {
            if (e.target.dataset.id) {
                selectedKiriman = allDestinationsForSearch.find(d => d.id == e.target.dataset.id);
                kirimanSearchInput.value = selectedKiriman.pt_tujuan;
                searchResultsDiv.classList.add('hidden');
                step2Kiriman.classList.remove('hidden');
                selectedDestinationText.textContent = selectedKiriman.pt_tujuan;
                selectedDestinationAddress.textContent = selectedKiriman.alamat;
                document.getElementById('group-from').value = 1;
            }
        });

        addProductRowBtn.addEventListener('click', () => addProductRow());
        multiProductContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-product-row-btn')) {
                e.target.closest('.product-row').remove();
            }
        });

        addGroupBtn.addEventListener('click', () => {
            const from = parseInt(document.getElementById('group-from').value, 10);
            const to = parseInt(document.getElementById('group-to').value, 10);
            const petugas = document.getElementById('group-petugas').value;
            const berat = document.getElementById('group-berat').value;

            if (!from || !to || to < from) {
                alert('Rentang nomor box tidak valid!');
                return;
            }

            const produk_list = [];
            multiProductContainer.querySelectorAll('.product-row').forEach(row => {
                const nama = row.querySelector('[name="group-produk-nama"]').value;
                const qty = row.querySelector('[name="group-produk-qty"]').value;
                if(nama) produk_list.push({ nama, qty });
            });
            
            tempGroups.push({ from, to, petugas, berat, produk_list });
            renderGroupsSummary();
            resetGroupForm();
            document.getElementById('group-from').value = to + 1;
        });
        
        groupsSummaryContainer.addEventListener('click', e => {
            if(e.target.classList.contains('delete-group-btn')) {
                const index = parseInt(e.target.dataset.index, 10);
                tempGroups.splice(index, 1);
                renderGroupsSummary();
            }
        });

        addToQueueBtn.addEventListener('click', () => {
            if (!selectedKiriman) { alert('Pilih alamat tujuan terlebih dahulu!'); return; }
            if (tempGroups.length === 0) { alert('Tambahkan minimal satu grup label!'); return; }

            const newKiriman = { 
                id: selectedKiriman.id, 
                pt_tujuan: selectedKiriman.pt_tujuan,
                status: 'undone',
                groups: tempGroups,
            };

            if (editingQueueIndex !== null) {
                printQueue[editingQueueIndex] = newKiriman;
            } else {
                printQueue.push(newKiriman);
            }

            renderPrintQueue();
            kirimanModal.classList.add('hidden');
        });

        printBatchBtn.addEventListener('click', () => {
            const toPrint = printQueue.filter(item => item.status === 'undone');
            if (toPrint.length === 0) { alert('Tidak ada item baru untuk dicetak.'); return; }
            let totalLabels = toPrint.reduce((acc, item) => {
                return acc + item.groups.reduce((gAcc, group) => gAcc + (group.to - group.from + 1), 0);
            }, 0);
            
            printSummary.innerHTML = `Anda akan mencetak total <strong>${totalLabels}</strong> label dari <strong>${toPrint.length}</strong> kiriman.`;
            printConfirmModal.classList.remove('hidden');
        });

        printFinalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const printerIp = printFinalForm.elements.printer_ip.value;
            const isDebug = printFinalForm.elements['debug-mode'].checked;
            
            const itemsToPrint = [];
            const itemsToUpdateStatus = printQueue.filter(item => item.status === 'undone');

            itemsToUpdateStatus.forEach(item => {
                const totalLabelsInKiriman = item.groups.reduce((acc, group) => acc + (group.to - group.from + 1), 0);
                
                item.groups.forEach(group => {
                    for(let i = group.from; i <= group.to; i++) {
                        const payload = {
                            id: item.id,
                            box_number: `${i}/${totalLabelsInKiriman}`,
                            petugas: group.petugas,
                            berat: group.berat,
                            // Mengirim data sebagai array of objects, sesuai kebutuhan template ZPL baru
                            produk_list: group.produk_list
                        };
                        itemsToPrint.push(payload);
                    }
                });
            });
            
            if (itemsToPrint.length === 0) { alert('Tidak ada item valid untuk dikirim.'); return; }
            
            try {
                const response = await fetch(`${API_URL}/print-batch`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ items: itemsToPrint, printer_ip: printerIp, debug: isDebug }) 
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                alert(result.message);
                itemsToUpdateStatus.forEach(item => item.status = 'done');
                renderPrintQueue();
                printConfirmModal.classList.add('hidden');
                fetchLogs(1);
            } catch (error) { 
                alert(`Error: ${error.message}`); 
            }
        });

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target.matches('.cancel-modal-btn') || e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });

        printQueueTableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const index = parseInt(button.dataset.index, 10);

            if (button.classList.contains('edit-queue-btn')) {
                const itemToEdit = printQueue[index];
                openKirimanModal(itemToEdit, index);
            }
            if (button.classList.contains('delete-queue-btn')) {
                if (confirm('Yakin ingin menghapus item ini dari antrian?')) {
                    printQueue.splice(index, 1);
                    renderPrintQueue();
                }
            }
        });

        addNewAddressBtn.addEventListener('click', () => openAddressModal('Tambah Alamat Baru'));
        addressSearchInput.addEventListener('input', (e) => {
            clearTimeout(addressDebounceTimer);
            addressDebounceTimer = setTimeout(() => fetchAddressData(1, e.target.value), 300);
        });
        addressPaginationControls.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && !button.disabled) fetchAddressData(parseInt(button.dataset.page), addressCurrentSearch);
        });
        addressForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = addressForm.elements.id.value;
            const url = id ? `${API_URL}/destinations/${id}` : `${API_URL}/destinations`;
            const method = id ? 'PUT' : 'POST';
            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(Object.fromEntries(new FormData(addressForm))) });
                if (!response.ok) throw new Error((await response.json()).error);
                addressModal.classList.add('hidden');
                fetchAddressData(id ? addressCurrentPage : 1, '');
                fetchAllDestinationsForSearch();
            } catch (error) { alert(`Error: ${error.message}`); }
        });
        addressTableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const destination = currentAddressItems.find(d => d.id == id);
            if (button.classList.contains('edit-address-btn') && destination) {
                openAddressModal('Edit Alamat', destination);
            }
        });
        logPaginationControls.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && !button.disabled) fetchLogs(parseInt(button.dataset.page));
        });

        const makeModalDraggable = (modalElement) => {
            const header = modalElement.querySelector('.modal-header');
            if (!header) return;
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            header.onmousedown = (e) => {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                document.onmousemove = (e) => {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    modalElement.style.top = (modalElement.offsetTop - pos2) + "px";
                    modalElement.style.left = (modalElement.offsetLeft - pos1) + "px";
                };
            };
        };

        // --- Inisialisasi ---
        fetchAllDestinationsForSearch();
        fetchAddressData();
        fetchLogs();
        document.querySelectorAll('.modal-content').forEach(mc => makeModalDraggable(mc));
    });
    </script>
</body>
</html>
